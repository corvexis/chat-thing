<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap');
        
        :root {
            --md-surface: #121212;
            --md-surface-container: #1E1E1E;
            --md-primary: #D0BCFF;
            --md-on-primary: #381E72;
            --md-primary-container: #4F378B;
            --md-on-primary-container: #EADDFF;
            --md-secondary-container: #333333;
            --md-outline: #938F99;
        }

        body { 
            font-family: 'Google Sans', sans-serif; 
            background-color: var(--md-surface);
            color: #E6E1E5;
        }

        .m3-card {
            background-color: var(--md-surface-container);
            border-radius: 28px;
        }

        .m3-fab {
            background-color: var(--md-primary-container);
            color: var(--md-on-primary-container);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .m3-input {
            background-color: transparent;
            border-bottom: 2px solid var(--md-outline);
            transition: border-color 0.3s ease;
        }
        .m3-input:focus {
            border-color: var(--md-primary);
            outline: none;
        }

        #chat-container::-webkit-scrollbar { width: 4px; }
        #chat-container::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        .message-anim {
            animation: m3-entry 0.4s cubic-bezier(0.05, 0.7, 0.1, 1);
        }

        @keyframes m3-entry {
            from { opacity: 0; transform: translateY(16px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .voice-pulse {
            animation: pulse-ring 1.5s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(208, 188, 255, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(208, 188, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(208, 188, 255, 0); }
        }

        /* Toast Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="toast-container"></div>

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-[#121212] flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center">
            <div class="mb-8 flex justify-center">
                <div class="w-16 h-16 bg-[#D0BCFF] rounded-3xl flex items-center justify-center rotate-12 shadow-2xl">
                    <i data-lucide="zap" class="text-[#381E72] w-8 h-8 fill-current"></i>
                </div>
            </div>
            <h1 class="text-3xl font-bold mb-2 tracking-tight text-white">Aether</h1>
            <p class="text-gray-400 mb-10">Encrypted Terminal Login</p>
            
            <div class="space-y-6 text-left">
                <input type="text" id="login-user" class="w-full m3-input py-3 px-1 text-lg text-white" placeholder="Username">
                <input type="password" id="login-pass" class="w-full m3-input py-3 px-1 text-lg text-white" placeholder="Passcode">
                <button id="login-btn" class="w-full py-4 bg-[#D0BCFF] text-[#381E72] rounded-full font-bold text-lg shadow-lg hover:brightness-110 transition-all">
                    Initialize Session
                </button>
                <p id="auth-error" class="text-red-400 text-sm text-center hidden font-medium uppercase tracking-widest mt-4">Access Denied</p>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="px-6 h-16 flex items-center justify-between bg-[#121212]/90 backdrop-blur-xl border-b border-white/5 z-10">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-[#4F378B] rounded-lg flex items-center justify-center">
                <i data-lucide="layers" class="text-[#D0BCFF] w-5 h-5"></i>
            </div>
            <span class="text-xl font-medium tracking-tight">Aether</span>
        </div>
        <div class="flex items-center gap-3">
            <div class="px-4 py-1.5 bg-[#4F378B] rounded-full flex items-center gap-2">
                <span id="user-display" class="text-xs font-bold text-[#EADDFF]">...</span>
                <div class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></div>
            </div>
            <button id="logout-btn" class="p-2 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="power" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main View -->
    <main class="flex-grow flex flex-col relative max-w-5xl mx-auto w-full">
        <div id="chat-container" class="flex-grow overflow-y-auto p-4 space-y-6 pb-32">
            <!-- Messages Load Here -->
        </div>

        <!-- Input Bar -->
        <div class="absolute bottom-6 left-4 right-4">
            <div class="m3-card p-2 flex items-end gap-2 shadow-2xl border border-white/5 bg-[#1E1E1E]/95 backdrop-blur-md">
                <button id="plus-btn" class="p-3.5 rounded-full hover:bg-white/5 text-gray-400">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </button>
                <input type="file" id="file-input" class="hidden" accept="image/*">
                
                <div class="flex-grow">
                    <div id="edit-chip" class="hidden text-[10px] bg-[#D0BCFF] text-[#381E72] px-2 py-0.5 rounded-full inline-block ml-2 mb-1 font-bold">EDITING</div>
                    <textarea id="msg-input" rows="1" class="w-full bg-transparent px-3 py-3 outline-none text-base text-white resize-none" placeholder="Message..."></textarea>
                </div>

                <button id="voice-trigger" class="p-3.5 rounded-full hover:bg-white/5 text-gray-400">
                    <i data-lucide="mic" class="w-6 h-6"></i>
                </button>
                <button id="send-btn" class="w-14 h-14 m3-fab flex items-center justify-center hover:scale-105 transition-transform flex-shrink-0">
                    <i data-lucide="arrow-up" id="btn-icon" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Voice Modal -->
    <div id="voice-overlay" class="hidden fixed inset-0 z-[120] bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
        <div class="bg-[#1E1E1E] rounded-[32px] p-8 w-full max-w-xs text-center border border-white/10 shadow-2xl">
            <div class="w-20 h-20 bg-[#D0BCFF] rounded-full flex items-center justify-center mx-auto mb-6 voice-pulse">
                <i data-lucide="mic" class="text-[#381E72] w-8 h-8"></i>
            </div>
            <p id="voice-timer" class="text-5xl font-bold mb-2 text-white tabular-nums">00:00</p>
            <p class="text-gray-500 text-xs mb-10 uppercase tracking-[0.3em]">Recording Data</p>
            <button id="stop-voice-btn" class="w-full py-4 bg-white/5 border border-white/10 rounded-full font-bold hover:bg-red-500/20 hover:text-red-400 transition-all">
                End Transmission
            </button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- CONFIG ---
        const SB_URL = 'https://hkiquoasmdhwzayvtjif.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhraXF1b2FzbWRod3pheXZ0amlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODcxMDMsImV4cCI6MjA4MTI2MzEwM30.T3MVzZia3HyJVqjF3tIKJcsZqmiiA6dBOpll-Tr84l4';
        const supabase = createClient(SB_URL, SB_KEY);

        let user = null;
        let editId = null;
        let recorder = null;
        let audioChunks = [];
        let timerInterval = null;

        // --- HELPERS ---
        const scroll = () => {
            const c = document.getElementById('chat-container');
            c.scrollTop = c.scrollHeight;
        };

        const updateIcons = () => lucide.createIcons();

        const showToast = (msg, isError = true) => {
            const toast = document.createElement('div');
            toast.className = `p-4 mb-2 rounded-xl text-sm font-medium shadow-2xl transition-all translate-x-10 opacity-0 ${isError ? 'bg-red-500/20 text-red-400 border border-red-500/50' : 'bg-green-500/20 text-green-400 border border-green-500/50'}`;
            toast.innerText = msg;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => { toast.classList.remove('translate-x-10', 'opacity-0'); }, 10);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        };

        // --- AUTH ---
        async function login() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            const err = document.getElementById('auth-error');

            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('username', u)
                .eq('passcode', p)
                .maybeSingle();

            if (error || !data) {
                err.classList.remove('hidden');
                if (error) showToast(`Login Error: ${error.message}`);
                return;
            }

            user = data;
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('user-display').innerText = user.username;
            init();
        }

        // --- UI FACTORY ---
        function renderMessage(msg) {
            const isMe = msg.user_id === user.id;
            const time = msg.created_at ? new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) : 'Just now';
            
            return `
                <div id="msg-${msg.id}" class="flex ${isMe ? 'justify-end' : 'justify-start'} message-anim group">
                    <div class="max-w-[85%] flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                        <div class="flex items-center gap-2 mb-1.5 px-2">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${isMe ? 'Host' : msg.username}</span>
                            <span class="text-[9px] text-gray-600">${time} ${msg.is_edited ? '[MOD]' : ''}</span>
                        </div>
                        <div class="relative p-4 rounded-[24px] ${isMe ? 'bg-[#D0BCFF] text-[#381E72] rounded-tr-none' : 'bg-[#333333] text-[#E6E1E5] rounded-tl-none'} shadow-lg">
                            ${msg.image_url ? `<img src="${msg.image_url}" class="rounded-xl max-h-80 w-auto mb-3 border border-black/10" />` : ''}
                            ${msg.audio_url ? `<audio src="${msg.audio_url}" controls class="h-8 w-48 mb-2 brightness-90 contrast-125 opacity-70"></audio>` : ''}
                            ${msg.text ? `<p class="text-[15px] leading-relaxed font-medium whitespace-pre-wrap">${msg.text}</p>` : ''}
                            
                            ${isMe ? `
                                <div class="absolute -top-3 -left-14 flex gap-1 opacity-0 group-hover:opacity-100 transition-all transform scale-90 group-hover:scale-100">
                                    <button data-action="edit" data-id="${msg.id}" data-text="${msg.text || ''}" class="p-2 bg-[#1E1E1E] border border-white/5 rounded-full shadow-xl text-[#D0BCFF] hover:brightness-150"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i></button>
                                    <button data-action="delete" data-id="${msg.id}" class="p-2 bg-[#1E1E1E] border border-white/5 rounded-full shadow-xl text-red-400 hover:brightness-150"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        async function init() {
            const { data, error } = await supabase.from('messages').select('*').order('created_at', { ascending: true });
            if (error) showToast(`Fetch Error: ${error.message}`);
            
            const chat = document.getElementById('chat-container');
            chat.innerHTML = (data || []).map(renderMessage).join('');
            updateIcons();
            scroll();

            supabase.channel('public_room')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, (p) => {
                    if (p.eventType === 'INSERT') {
                        chat.insertAdjacentHTML('beforeend', renderMessage(p.new));
                        scroll();
                    } else if (p.eventType === 'UPDATE') {
                        const el = document.getElementById(`msg-${p.new.id}`);
                        if (el) el.outerHTML = renderMessage(p.new);
                    } else if (p.eventType === 'DELETE') {
                        document.getElementById(`msg-${p.old.id}`)?.remove();
                    }
                    updateIcons();
                }).subscribe();
        }

        // --- ACTIONS ---
        async function send() {
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if (!txt && !editId) return;

            if (editId) {
                const { error } = await supabase.from('messages')
                    .update({ text: txt, is_edited: true })
                    .eq('id', editId);
                
                if (error) {
                    showToast(`Update Error: ${error.message}`);
                } else {
                    cancelEdit();
                }
            } else {
                // IMPORTANT: Ensure your table matches these field names exactly
                const { error } = await supabase.from('messages').insert({ 
                    user_id: user.id, 
                    username: user.username, 
                    text: txt 
                });
                
                if (error) {
                    showToast(`Post Error: ${error.message}`);
                } else {
                    input.value = '';
                    input.style.height = 'auto';
                }
            }
        }

        const cancelEdit = () => {
            editId = null;
            document.getElementById('msg-input').value = '';
            document.getElementById('edit-chip').classList.add('hidden');
            document.getElementById('btn-icon').setAttribute('data-lucide', 'arrow-up');
            updateIcons();
        };

        // --- EVENT DELEGATION ---
        document.getElementById('chat-container').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const { action, id, text } = btn.dataset;

            if (action === 'delete') {
                if (confirm("Destroy this data packet?")) {
                    const { error } = await supabase.from('messages').delete().eq('id', id);
                    if (error) showToast(error.message);
                }
            } else if (action === 'edit') {
                editId = id;
                const input = document.getElementById('msg-input');
                input.value = text;
                input.focus();
                document.getElementById('edit-chip').classList.remove('hidden');
                document.getElementById('btn-icon').setAttribute('data-lucide', 'check');
                updateIcons();
            }
        });

        // --- MEDIA ---
        const uploadImage = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const path = `img/${Date.now()}_${file.name}`;
            const { data, error } = await supabase.storage.from('media').upload(path, file);
            
            if (error) {
                showToast(`Storage Error: ${error.message}`);
                return;
            }
            
            const { data: { publicUrl } } = supabase.storage.from('media').getPublicUrl(path);
            const { error: dbError } = await supabase.from('messages').insert({ 
                user_id: user.id, 
                username: user.username, 
                image_url: publicUrl 
            });
            
            if (dbError) showToast(dbError.message);
        };

        const toggleVoice = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
                audioChunks = [];
                recorder.ondataavailable = e => audioChunks.push(e.data);
                recorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const path = `voice/${Date.now()}.webm`;
                    const { data, error } = await supabase.storage.from('media').upload(path, blob);
                    
                    if (error) {
                        showToast(error.message);
                    } else {
                        const { data: { publicUrl } } = supabase.storage.from('media').getPublicUrl(path);
                        const { error: dbError } = await supabase.from('messages').insert({ 
                            user_id: user.id, 
                            username: user.username, 
                            audio_url: publicUrl 
                        });
                        if (dbError) showToast(dbError.message);
                    }
                    stream.getTracks().forEach(t => t.stop());
                };
                recorder.start();
                document.getElementById('voice-overlay').classList.remove('hidden');
                let s = 0;
                timerInterval = setInterval(() => {
                    s++;
                    const m = Math.floor(s/60).toString().padStart(2, '0');
                    const sec = (s%60).toString().padStart(2, '0');
                    document.getElementById('voice-timer').innerText = `${m}:${sec}`;
                }, 1000);
            } catch (e) { showToast("Microphone access denied."); }
        };

        const stopVoice = () => {
            if (recorder && recorder.state !== 'inactive') recorder.stop();
            clearInterval(timerInterval);
            document.getElementById('voice-overlay').classList.add('hidden');
            document.getElementById('voice-timer').innerText = "00:00";
        };

        // --- BINDINGS ---
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('send-btn').addEventListener('click', send);
        document.getElementById('logout-btn').addEventListener('click', () => location.reload());
        document.getElementById('plus-btn').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', uploadImage);
        document.getElementById('voice-trigger').addEventListener('click', toggleVoice);
        document.getElementById('stop-voice-btn').addEventListener('click', stopVoice);

        document.getElementById('msg-input').onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                send();
            }
        };
        
        const tx = document.getElementById('msg-input');
        tx.oninput = () => {
            tx.style.height = 'auto';
            tx.style.height = (tx.scrollHeight) + 'px';
        };

        updateIcons();
    </script>
</body>
</html>
