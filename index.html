<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether Chat | Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
    <script src="https://cdn.jsdelivr.net/npm/audio-recorder-polyfill@0.1.0/audio-recorder-polyfill.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-track { background: transparent; }
        #chat-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        .message-bubble:hover .action-btns { opacity: 1; }
        
        .shimmer {
            background: linear-gradient(90deg, #6366f1, #a855f7, #6366f1);
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 h-screen overflow-hidden flex flex-col">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#020617]/95 transition-opacity duration-500">
        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl border border-indigo-500/30">
            <div class="text-center mb-8">
                <div class="inline-flex p-3 bg-indigo-500/20 rounded-full mb-4">
                    <i data-lucide="cloud-lightning" class="w-8 h-8 text-indigo-400"></i>
                </div>
                <h2 class="text-3xl font-bold text-white tracking-tight">Aether Chat</h2>
                <p class="text-slate-400 mt-2">Enter your credentials to connect</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Username</label>
                    <input type="text" id="login-user" class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="e.g. pilot_01">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Passcode</label>
                    <input type="password" id="login-pass" class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="••••">
                </div>
                <button id="login-submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg shadow-indigo-500/20 transition-all flex items-center justify-center space-x-2">
                    <span>Connect to Aether</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
                <p id="auth-error" class="text-red-400 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="flex-grow flex flex-col max-w-6xl mx-auto w-full p-4 md:p-6 h-full overflow-hidden">
        
        <!-- Navbar -->
        <nav class="glass rounded-2xl p-4 mb-4 flex justify-between items-center shadow-xl">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center">
                    <i data-lucide="zap" class="text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white">Aether Chat</h1>
                    <div class="flex items-center text-[10px] text-green-400 uppercase tracking-widest font-bold">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5 animate-pulse"></span>
                        Secure Link Established
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <button onclick="summarizeChat()" class="p-2.5 rounded-xl hover:bg-white/10 transition group text-indigo-400" title="AI Summary">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                </button>
                <div class="h-6 w-px bg-slate-700 mx-1"></div>
                <div class="text-right mr-3 hidden sm:block">
                    <p id="nav-username" class="text-sm font-semibold text-white">...</p>
                    <p class="text-[10px] text-slate-500 uppercase">Active Profile</p>
                </div>
                <button onclick="handleLogout()" class="p-2.5 rounded-xl hover:bg-red-500/10 text-slate-400 hover:text-red-400 transition">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </nav>

        <!-- Chat Stream -->
        <main class="flex-grow glass rounded-2xl flex flex-col overflow-hidden relative shadow-2xl">
            <div id="chat-container" class="flex-grow overflow-y-auto p-6 space-y-6">
                <!-- Messages populate here -->
            </div>

            <!-- Typing/Action Indicators -->
            <div id="status-bar" class="px-6 py-2 text-xs text-indigo-400 font-medium bg-indigo-500/5 hidden border-t border-indigo-500/10">
                <span id="status-text"></span>
            </div>

            <!-- Composer -->
            <div class="p-4 border-t border-white/5 bg-slate-900/50">
                <div id="edit-banner" class="hidden bg-amber-500/10 border border-amber-500/20 p-2 rounded-lg mb-3 flex justify-between items-center text-xs">
                    <span class="text-amber-400 flex items-center"><i data-lucide="edit-3" class="w-3 h-3 mr-2"></i> Editing message...</span>
                    <button onclick="cancelEditing()" class="text-slate-400 hover:text-white">Cancel</button>
                </div>

                <form id="chat-form" class="flex items-end space-x-3">
                    <div class="flex-grow relative">
                        <textarea id="message-input" rows="1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 pr-12 focus:ring-2 focus:ring-indigo-500 outline-none transition resize-none min-h-[48px] max-h-32 text-sm" placeholder="Send a message..."></textarea>
                        <button type="button" onclick="magicDraft()" class="absolute right-3 bottom-3 text-indigo-400 hover:text-indigo-300 transition" title="AI Magic Draft">
                            <i data-lucide="wand-2" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="flex items-center space-x-2 pb-1">
                        <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageSelect(this)">
                        <button type="button" onclick="document.getElementById('image-input').click()" class="p-3 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl transition shadow-lg">
                            <i data-lucide="image" class="w-5 h-5"></i>
                        </button>
                        <button type="button" id="voice-trigger" onclick="toggleVoiceModal()" class="p-3 bg-slate-800 hover:bg-slate-700 text-red-400 rounded-xl transition shadow-lg">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                        </button>
                        <button type="submit" class="p-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl transition shadow-lg shadow-indigo-600/20">
                            <i data-lucide="send" id="send-icon" class="w-5 h-5"></i>
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="voice-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass p-8 rounded-3xl w-80 text-center border-red-500/20">
            <div id="voice-waves" class="flex justify-center items-center space-x-1 mb-6 h-12">
                <div class="w-1 h-4 bg-red-500 rounded-full animate-bounce"></div>
                <div class="w-1 h-8 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-1 h-12 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-1 h-6 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0.3s"></div>
            </div>
            <p id="voice-timer" class="text-4xl font-mono font-bold text-white mb-2">00:00</p>
            <p class="text-xs text-slate-400 uppercase tracking-widest mb-8">Recording Audio</p>
            
            <div class="flex justify-center space-x-4">
                <button id="stop-record" class="p-4 bg-red-600 rounded-full text-white shadow-xl shadow-red-600/20"><i data-lucide="square" class="w-6 h-6"></i></button>
            </div>
        </div>
    </div>

    <div id="summary-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass p-8 rounded-3xl max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-indigo-400 flex items-center mb-4">
                <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Conversation Intel
            </h3>
            <div id="summary-text" class="text-sm text-slate-300 leading-relaxed space-y-2"></div>
            <button onclick="toggleSummaryModal(false)" class="w-full mt-6 py-3 bg-slate-800 rounded-xl font-bold hover:bg-slate-700 transition">Understood</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Config ---
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';
        const apiKey = ""; // Gemini API Key

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- State ---
        let currentUser = null;
        let editingId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordStartTime = null;
        let timerInterval = null;

        // --- Auth Logic ---
        async function handleLogin() {
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const errorEl = document.getElementById('auth-error');

            if (!user || !pass) return;

            // Manual check against profiles table
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('username', user)
                .eq('passcode', pass)
                .single();

            if (error || !data) {
                errorEl.innerText = "Invalid credentials";
                errorEl.classList.remove('hidden');
                return;
            }

            currentUser = data;
            document.getElementById('auth-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('auth-overlay').classList.add('hidden'), 500);
            document.getElementById('nav-username').innerText = currentUser.username;
            loadMessages();
            subscribeToMessages();
        }

        window.handleLogout = () => location.reload();

        // --- Message Rendering ---
        function createMessageHTML(msg) {
            const isMe = msg.user_id === currentUser.id;
            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            return `
                <div id="msg-${msg.id}" class="flex ${isMe ? 'justify-end' : 'justify-start'} group">
                    <div class="max-w-[80%] ${isMe ? 'order-1' : 'order-2'}">
                        <div class="flex items-center space-x-2 mb-1 px-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">${isMe ? 'You' : msg.username}</span>
                            <span class="text-[9px] text-slate-600">${time} ${msg.is_edited ? '• EDITED' : ''}</span>
                        </div>
                        <div class="message-bubble relative p-3 rounded-2xl ${isMe ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none'} shadow-lg">
                            ${msg.image_url ? `<img src="${msg.image_url}" class="rounded-lg max-h-64 object-cover mb-2" />` : ''}
                            ${msg.audio_url ? `<audio controls src="${msg.audio_url}" class="h-8 w-48 invert grayscale brightness-200"></audio>` : ''}
                            ${msg.text ? `<p class="text-sm leading-relaxed">${msg.text}</p>` : ''}
                            
                            ${isMe ? `
                                <div class="action-btns opacity-0 absolute top-0 -left-12 flex space-x-1 p-1 transition-opacity">
                                    <button onclick="startEdit(${msg.id}, \`${msg.text}\`)" class="p-1.5 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="deleteMessage(${msg.id})" class="p-1.5 hover:bg-red-500/20 rounded-lg text-slate-400 hover:text-red-400"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadMessages() {
            const { data } = await supabase.from('messages').select('*').order('created_at', { ascending: true });
            const container = document.getElementById('chat-container');
            container.innerHTML = data.map(createMessageHTML).join('');
            lucide.createIcons();
            scrollToBottom();
        }

        function subscribeToMessages() {
            supabase.channel('public:messages')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {
                    if (payload.eventType === 'INSERT') {
                        document.getElementById('chat-container').insertAdjacentHTML('beforeend', createMessageHTML(payload.new));
                        scrollToBottom();
                    } else if (payload.eventType === 'UPDATE') {
                        const el = document.getElementById(`msg-${payload.new.id}`);
                        if (el) el.outerHTML = createMessageHTML(payload.new);
                    } else if (payload.eventType === 'DELETE') {
                        document.getElementById(`msg-${payload.old.id}`)?.remove();
                    }
                    lucide.createIcons();
                }).subscribe();
        }

        // --- Sending Actions ---
        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text && !editingId) return;

            if (editingId) {
                await supabase.from('messages').update({ text, is_edited: true }).eq('id', editingId);
                cancelEditing();
            } else {
                await supabase.from('messages').insert({ 
                    user_id: currentUser.id, 
                    username: currentUser.username, 
                    text 
                });
            }
            input.value = '';
        }

        window.deleteMessage = async (id) => {
            if (confirm("Erase this data from Aether?")) {
                await supabase.from('messages').delete().eq('id', id);
            }
        };

        window.startEdit = (id, text) => {
            editingId = id;
            const input = document.getElementById('message-input');
            input.value = text;
            input.focus();
            document.getElementById('edit-banner').classList.remove('hidden');
            document.getElementById('send-icon').setAttribute('data-lucide', 'check');
            lucide.createIcons();
        };

        window.cancelEditing = () => {
            editingId = null;
            document.getElementById('message-input').value = '';
            document.getElementById('edit-banner').classList.add('hidden');
            document.getElementById('send-icon').setAttribute('data-lucide', 'send');
            lucide.createIcons();
        };

        // --- Media Handlers ---
        window.handleImageSelect = async (input) => {
            const file = input.files[0];
            if (!file) return;

            showStatus("Uploading visual data...");
            const fileName = `${Date.now()}-${file.name}`;
            const { data, error } = await supabase.storage.from('media').upload(`images/${fileName}`, file);
            
            if (data) {
                const { data: urlData } = supabase.storage.from('media').getPublicUrl(`images/${fileName}`);
                await supabase.from('messages').insert({
                    user_id: currentUser.id,
                    username: currentUser.username,
                    image_url: urlData.publicUrl
                });
            }
            hideStatus();
        };

        // --- Voice Logic ---
        window.toggleVoiceModal = async () => {
            const modal = document.getElementById('voice-modal');
            modal.classList.remove('hidden');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    showStatus("Processing audio stream...");
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const fileName = `${Date.now()}.webm`;
                    const { data } = await supabase.storage.from('media').upload(`audio/${fileName}`, blob);
                    
                    if (data) {
                        const { data: urlData } = supabase.storage.from('media').getPublicUrl(`audio/${fileName}`);
                        await supabase.from('messages').insert({
                            user_id: currentUser.id,
                            username: currentUser.username,
                            audio_url: urlData.publicUrl
                        });
                    }
                    hideStatus();
                    stream.getTracks().forEach(t => t.stop());
                };

                mediaRecorder.start();
                startTimer();
            } catch (err) {
                modal.classList.add('hidden');
                console.error(err);
            }
        };

        function startTimer() {
            recordStartTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - recordStartTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('voice-timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        document.getElementById('stop-record').onclick = () => {
            mediaRecorder.stop();
            clearInterval(timerInterval);
            document.getElementById('voice-modal').classList.add('hidden');
        };

        // --- AI Intelligence ---
        window.magicDraft = async () => {
            const input = document.getElementById('message-input');
            if (!input.value.trim()) return;
            
            showStatus("Consulting Aether AI...");
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Rewrite this message to be professional yet friendly. Only return the revised text: "${input.value}"` }] }]
                    })
                });
                const json = await response.json();
                input.value = json.candidates[0].content.parts[0].text.trim();
            } catch (e) { console.error(e); }
            hideStatus();
        };

        window.summarizeChat = async () => {
            const messages = Array.from(document.querySelectorAll('.message-bubble p')).slice(-20).map(p => p.innerText);
            if (messages.length < 5) return;

            toggleSummaryModal(true);
            document.getElementById('summary-text').innerHTML = "Synthesizing chat patterns...";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Summarize these recent chat messages into 3 concise bullet points:\n${messages.join('\n')}` }] }]
                    })
                });
                const json = await response.json();
                const text = json.candidates[0].content.parts[0].text;
                document.getElementById('summary-text').innerText = text;
            } catch (e) {
                document.getElementById('summary-text').innerText = "AI node unavailable.";
            }
        };

        window.toggleSummaryModal = (show) => {
            document.getElementById('summary-modal').classList.toggle('hidden', !show);
        };

        // --- Utilities ---
        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function showStatus(text) {
            const bar = document.getElementById('status-bar');
            document.getElementById('status-text').innerText = text;
            bar.classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('status-bar').classList.add('hidden');
        }

        // Init
        document.getElementById('login-submit').onclick = handleLogin;
        document.getElementById('chat-form').onsubmit = sendMessage;
        
        // Auto-resize textarea
        const textarea = document.getElementById('message-input');
        textarea.oninput = () => {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        };

        lucide.createIcons();
    </script>
</body>
</html>
