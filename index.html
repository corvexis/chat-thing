<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Chat (Supabase)</title>
    <!-- Tailwind CSS CDN (For development/single-file environments) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for chat scroll and input */
        #chat-container {
            /* Height is handled by flex-grow in parent, but this is a fallback if needed */
            height: 100%; 
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Modal backdrop style */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(2px);
        }
        /* Style for the delete/edit button container hover effect */
        .message-bubble:hover .delete-btn-group {
            opacity: 1;
        }
        .delete-btn-group {
            opacity: 0;
            transition: opacity 0.2s;
        }
        /* Style for the voice message button */
        #voice-message-btn {
            background-image: linear-gradient(to right, #ef4444 0%, #dc2626 100%);
        }
        #voice-message-btn:hover {
            background-image: linear-gradient(to right, #dc2626 0%, #b91c1c 100%);
        }
        /* Scrollbar styling for modern browsers */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray-600 */
            border-radius: 4px;
        }
        #chat-container::-webkit-scrollbar-track {
            background-color: #1f2937; /* Gray-800 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex flex-col">

    <!-- Supabase Client Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Application Header -->
    <header class="bg-gray-800 p-4 shadow-lg flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold text-indigo-400">Nexus Chat</h1>
            <div id="auth-status" class="text-sm px-3 py-1 bg-gray-700 rounded-full text-red-400">Loading Auth...</div>
        </div>
        <div class="text-right">
            <h2 id="chat-header" class="text-lg font-semibold text-gray-200">Public Chat</h2>
            <div id="user-info" class="text-xs text-gray-400">User ID: N/A</div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar for DM partners -->
        <div id="dm-sidebar" class="w-1/4 bg-gray-800 border-r border-gray-700 flex flex-col p-4 overflow-y-auto">
            <h3 class="text-xl font-semibold mb-4 text-indigo-300 border-b border-gray-700 pb-2">Direct Messages</h3>
            <div id="dm-list" class="space-y-2 flex-1">
                <!-- DM partners will be rendered here -->
            </div>
            <button onclick="setChatMode('public')" class="mt-4 w-full py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-medium transition duration-150 shadow-md">
                Switch to Public Chat
            </button>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col p-4 overflow-hidden">
            <!-- Messages Container -->
            <div id="chat-container" class="flex-1 space-y-4 mb-4 p-4 bg-gray-800 rounded-xl shadow-inner border border-gray-700">
                <!-- Chat messages will be rendered here -->
            </div>

            <!-- Message Input Area -->
            <div class="flex space-x-3 items-end">
                <textarea id="message-input" class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-xl text-gray-100 resize-none focus:ring-2 focus:ring-indigo-500 transition duration-150" rows="1" placeholder="Type your message or ask for help..."></textarea>
                
                <button id="send-btn" class="p-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg flex-shrink-0" onclick="sendMessage()">
                    <!-- Send Icon (Lucide Icon: send) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </button>

                <div class="relative flex-shrink-0">
                    <!-- Record Start Button (Mic Icon) -->
                    <button id="record-start-btn" class="p-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition duration-150 shadow-lg">
                        <!-- Mic Icon (Lucide Icon: mic) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    </button>
                    <!-- Record Stop Button (Stop Icon) - Hidden by default -->
                    <button id="record-stop-btn" class="p-3 bg-gray-500 text-white rounded-xl transition duration-150 hidden absolute top-0 left-0 w-full h-full" style="background-image: linear-gradient(to right, #ef4444 0%, #dc2626 100%);">
                        <!-- Stop Circle Icon (Lucide Icon: stop-circle) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9 9h6v6H9z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit/Delete Modal -->
    <div id="modal-container" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4 z-50">
        <div id="edit-modal" class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700 transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold mb-4 text-indigo-400">Edit Message</h3>
            <textarea id="edit-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 resize-none mb-4" rows="4"></textarea>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150">Cancel</button>
                <button id="modal-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">Save Changes</button>
                <button id="modal-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Delete</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // --- Supabase Setup ---
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // NOTE: REPLACE THESE WITH YOUR ACTUAL SUPABASE PROJECT DETAILS
        // These are placeholder values and MUST be replaced for the app to work.
        const SUPABASE_URL = 'https://hkiquoasmdhwzayvtjif.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhraXF1b2FzbWRod3pheXZ0amlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODcxMDMsImV4cCI6MjA4MTI2MzEwM30.T3MVzZia3HyJVqjF3tIKJcsZqmiiA6dBOpll-Tr84l4'; 

        let supabaseClient;
        let auth;
        let currentUserId = null;
        let currentPartnerId = null; // Used for DM mode
        let currentPartnerName = 'Public';
        let subscription = null; // For real-time subscription

        // Elements
        const messageInput = document.getElementById('message-input');
        const chatContainer = document.getElementById('chat-container');
        const dmList = document.getElementById('dm-list');
        const recordStartBtn = document.getElementById('record-start-btn');
        const recordStopBtn = document.getElementById('record-stop-btn');
        const modalContainer = document.getElementById('modal-container');
        const editInput = document.getElementById('edit-input');

        // Voice Recording State
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // --- Utility Functions ---

        /**
         * Simple exponential backoff for retrying API calls.
         * @param {function} fn - The function to execute.
         * @param {number} maxRetries - Maximum number of retries.
         * @returns {Promise<any>}
         */
        async function withExponentialBackoff(fn, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    // console.warn(`Retry attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateHeader() {
            document.getElementById('chat-header').textContent = currentPartnerName === 'Public' ? 'Public Chat' : `DM with ${currentPartnerName}`;
        }

        // --- Authentication and UI Updates ---

        async function updateAuthState(session) {
            const authStatus = document.getElementById('auth-status');
            const userInfo = document.getElementById('user-info');
            
            if (session?.user) {
                currentUserId = session.user.id;
                authStatus.textContent = 'Authenticated';
                authStatus.classList.replace('text-red-400', 'text-green-400');
                userInfo.textContent = `User ID: ${currentUserId.substring(0, 8)}...`;
                
                // Fetch initial data and set up real-time listener
                await fetchCurrentMessages().then(renderMessages);
                await fetchActiveDMPartners();
                subscribeToMessages();
                
            } else {
                currentUserId = null;
                authStatus.textContent = 'Unauthenticated';
                authStatus.classList.replace('text-green-400', 'text-red-400');
                userInfo.textContent = 'User ID: N/A';

                // Attempt to sign in anonymously if unauthenticated
                await withExponentialBackoff(() => supabaseClient.auth.signInAnonymously())
                    .catch(err => {
                        console.error("Failed to sign in anonymously:", err);
                        authStatus.textContent = 'Auth Failed';
                        userInfo.textContent = 'Could not authenticate.';
                    });
            }
        }

        // --- Chat Mode Management ---

        function setChatMode(mode, partnerId = null, partnerName = 'Public') {
            if (!currentUserId) return; // Must be authenticated to switch mode

            currentPartnerId = partnerId;
            currentPartnerName = partnerName;
            updateHeader();
            
            // Clear current messages
            chatContainer.innerHTML = '';
            
            // Update DM list highlighting
            document.querySelectorAll('.dm-item').forEach(el => {
                el.classList.remove('bg-indigo-600', 'text-white');
                el.classList.add('hover:bg-gray-600');
                if (partnerId && el.dataset.partnerId === partnerId) {
                    el.classList.remove('hover:bg-gray-600');
                    el.classList.add('bg-indigo-600', 'text-white');
                }
            });
            
            // If in public mode, remove DM highlighting
            if (mode === 'public') {
                document.querySelectorAll('.dm-item').forEach(el => {
                    el.classList.remove('bg-indigo-600', 'text-white');
                    el.classList.add('hover:bg-gray-600');
                });
            }

            // Unsubscribe from previous and subscribe to new
            if (subscription) {
                supabaseClient.removeChannel(subscription);
            }
            
            fetchCurrentMessages().then(renderMessages);
            subscribeToMessages();
        }

        // --- Data Fetching and Real-Time Subscription ---
        
        async function fetchCurrentMessages() {
            if (!currentUserId) return [];

            if (currentPartnerId) {
                // DM Mode
                // Find messages where sender is currentUserId AND receiver is currentPartnerId
                // OR sender is currentPartnerId AND receiver is currentUserId
                const { data: messages, error } = await withExponentialBackoff(() => 
                    supabaseClient
                        .from('messages')
                        .select('*')
                        .or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${currentPartnerId}),and(sender_id.eq.${currentPartnerId},receiver_id.eq.${currentUserId})`)
                        .order('created_at', { ascending: true })
                );

                if (error) {
                    console.error("Error fetching DM messages:", error);
                    return [];
                }
                return messages;

            } else {
                // Public Mode
                const { data: messages, error } = await withExponentialBackoff(() => 
                    supabaseClient
                        .from('messages')
                        .select('*')
                        .is('receiver_id', null) // Public messages have a null receiver_id
                        .order('created_at', { ascending: true })
                );

                if (error) {
                    console.error("Error fetching public messages:", error);
                    return [];
                }
                return messages;
            }
        }
        
        async function fetchActiveDMPartners() {
            if (!currentUserId) return;

            // Fetch all users the current user has sent or received a message from
            const { data: messages, error } = await withExponentialBackoff(() => 
                supabaseClient
                    .from('messages')
                    .select('sender_id, receiver_id')
                    .or(`sender_id.eq.${currentUserId},receiver_id.eq.${currentUserId}`)
            );

            if (error) {
                console.error("Error fetching DM message history:", error);
                return;
            }

            const partnerIds = new Set();
            messages.forEach(msg => {
                if (msg.sender_id && msg.sender_id !== currentUserId && !partnerIds.has(msg.sender_id)) {
                    partnerIds.add(msg.sender_id);
                }
                if (msg.receiver_id && msg.receiver_id !== currentUserId && !partnerIds.has(msg.receiver_id)) {
                    partnerIds.add(msg.receiver_id);
                }
            });

            dmList.innerHTML = `
                <div class="text-sm text-gray-400 p-2 border-b border-gray-700">
                    Your User ID: ${currentUserId.substring(0, 8)}...
                </div>
            `;
            
            partnerIds.forEach(id => {
                // For simplicity, we use the first 8 characters of the ID as the name
                const partnerName = id.substring(0, 8);
                const isActive = id === currentPartnerId;
                
                const item = document.createElement('div');
                item.className = `dm-item p-3 rounded-lg cursor-pointer transition duration-150 flex justify-between items-center ${isActive ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-200 hover:bg-gray-600'}`;
                item.dataset.partnerId = id;
                item.innerHTML = `
                    <span class="font-medium truncate">User: ${partnerName}...</span>
                    <!-- DM Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                `;
                item.onclick = () => setChatMode('dm', id, partnerName);
                dmList.appendChild(item);
            });
            
            // Add a link to self to allow DMs to others based on shared ID
            const addDmItem = document.createElement('div');
            addDmItem.className = 'p-3 text-sm text-gray-400 italic border border-dashed border-gray-600 rounded-lg cursor-pointer hover:bg-gray-700 transition duration-150 mt-4';
            addDmItem.textContent = 'Click on a user ID in the chat to start a new DM.';
            dmList.appendChild(addDmItem);
        }

        function subscribeToMessages() {
            if (!currentUserId) return;

            const channel = supabaseClient.channel('chat-room');
            
            // Filter criteria for DM or Public chat
            const filter = currentPartnerId
                ? `or(sender_id.eq.${currentUserId},receiver_id.eq.${currentUserId})` // DM filter is complex, subscribing to all related updates
                : 'receiver_id.is.null'; // Public filter

            subscription = channel
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'messages', 
                    filter: filter 
                }, (payload) => {
                    // console.log('Change received!', payload);
                    
                    if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE' || payload.eventType === 'DELETE') {
                        // Re-fetch and re-render the current view to ensure accuracy,
                        // especially for complex DM filtering and updates.
                        fetchCurrentMessages().then(renderMessages);
                        fetchActiveDMPartners(); // Update DM list on any message
                    }
                })
                .subscribe();
        }


        // --- Message Rendering ---
        
        function createMessageElement(message) {
            const isMe = message.sender_id === currentUserId;
            const messageElement = document.createElement('div');
            messageElement.className = `flex mb-2 ${isMe ? 'justify-end' : 'justify-start'}`;
            
            const senderName = message.sender_id ? message.sender_id.substring(0, 8) : 'Unknown';
            const bgColor = isMe ? 'bg-indigo-600' : 'bg-gray-700';
            const textColor = isMe ? 'text-white' : 'text-gray-200';
            
            let messageContent;
            if (message.audio_url) {
                messageContent = `
                    <div class="flex items-center space-x-2">
                        <!-- Play/Pause Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="audio-play-icon cursor-pointer"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        <audio src="${message.audio_url}" class="hidden"></audio>
                        <span>Voice Message (${new Date(message.created_at).toLocaleTimeString()})</span>
                    </div>
                `;
            } else {
                messageContent = `
                    <p class="whitespace-pre-wrap">${message.content}</p>
                `;
            }

            messageElement.innerHTML = `
                <div class="flex flex-col max-w-xl">
                    <div class="text-xs ${isMe ? 'text-right' : 'text-left'} mb-1">
                        <span class="font-bold text-indigo-300 cursor-pointer hover:underline" onclick="setChatMode('dm', '${message.sender_id}', '${senderName}')">${isMe ? 'You' : senderName + '...'}</span>
                        <span class="text-gray-400 ml-1">
                            ${!currentPartnerId ? (message.receiver_id ? '(DM)' : '(Public)') : ''}
                        </span>
                    </div>
                    <div class="relative flex items-center space-x-2">
                        <!-- Controls for Edit/Delete -->
                        <div class="delete-btn-group flex space-x-1 ${isMe ? 'order-2' : 'order-1'}">
                            ${isMe ? `
                                <button onclick="openModal(${message.id}, '${message.content.replace(/'/g, "\\'")}')" class="text-sm p-1 text-gray-300 hover:text-yellow-400 transition duration-150">
                                    <!-- Edit Icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                </button>
                                <button onclick="deleteMessage(${message.id})" class="text-sm p-1 text-gray-300 hover:text-red-400 transition duration-150">
                                    <!-- Trash Icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            ` : ''}
                        </div>
                        
                        <div class="message-bubble p-3 rounded-xl ${bgColor} ${textColor} shadow-md ${isMe ? 'order-1 rounded-br-none' : 'order-2 rounded-tl-none'}">
                            ${messageContent}
                        </div>
                    </div>
                </div>
            `;
            
            // Add audio event listener if it's a voice message
            if (message.audio_url) {
                const audio = messageElement.querySelector('audio');
                const icon = messageElement.querySelector('.audio-play-icon');
                
                if (audio && icon) {
                    icon.onclick = () => {
                        if (audio.paused) {
                            // Pause all other audio first
                            document.querySelectorAll('audio').forEach(a => {
                                if (a !== audio) {
                                    a.pause();
                                    a.parentElement.querySelector('.audio-play-icon').innerHTML = '<polygon points="5 3 19 12 5 21 5 3"/>';
                                }
                            });

                            audio.play();
                            // Pause Icon (Lucide Icon: pause)
                            icon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'; 
                        } else {
                            audio.pause();
                            // Play Icon
                            icon.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"/>';
                        }
                    };
                    
                    audio.onended = () => {
                        // Play Icon
                        icon.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"/>';
                    };
                }
            }

            return messageElement;
        }

        function renderMessages(messages) {
            chatContainer.innerHTML = '';
            if (!messages || messages.length === 0) {
                chatContainer.innerHTML = '<p class="text-center text-gray-500 italic">No messages yet. Say hello!</p>';
                return;
            }
            messages.forEach(message => {
                chatContainer.appendChild(createMessageElement(message));
            });
            scrollToBottom();
        }

        // --- Message Actions (Send, Edit, Delete) ---

        async function sendMessage() {
            if (!currentUserId) return console.error("User not authenticated.");
            
            const content = messageInput.value.trim();
            if (content === '') return;
            
            messageInput.value = '';
            
            const message = {
                sender_id: currentUserId,
                content: content,
                receiver_id: currentPartnerId // null for public, ID for DM
            };

            const { error } = await withExponentialBackoff(() => 
                supabaseClient
                    .from('messages')
                    .insert([message])
            );

            if (error) {
                console.error("Error sending message:", error);
                messageInput.value = content; // Restore content if failed
            }
        }
        
        async function editMessage(id, newContent) {
            if (!currentUserId || !newContent.trim()) return;

            const { error } = await withExponentialBackoff(() => 
                supabaseClient
                    .from('messages')
                    .update({ content: newContent.trim() })
                    .eq('id', id)
                    .eq('sender_id', currentUserId) // Security check
            );
            
            if (error) {
                console.error("Error updating message:", error);
            }
            closeModal();
        }

        async function deleteMessage(id) {
            // Note: We use a custom modal for confirmation instead of window.confirm()
            if (!currentUserId) return;

            // Simple Confirmation Logic within the modal structure
            if (!document.getElementById('edit-modal').dataset.messageId) {
                // If deletion is triggered via the delete button in the modal, proceed
                // This means the modal is already open, and the ID is set.
                // If it's triggered by the icon directly, we call openModal first (see below)
            }

            const { error } = await withExponentialBackoff(() => 
                supabaseClient
                    .from('messages')
                    .delete()
                    .eq('id', id)
                    .eq('sender_id', currentUserId) // Security check
            );

            if (error) {
                console.error("Error deleting message:", error);
            }
            closeModal();
            // Real-time listener handles UI update, but a manual fetch ensures consistency
            fetchCurrentMessages().then(renderMessages);
        }

        // --- Modal Control ---
        
        function openModal(id, content) {
            if (!currentUserId) return;

            editInput.value = content;
            document.getElementById('edit-modal').dataset.messageId = id;
            
            // Set up save button handler
            document.getElementById('modal-save-btn').onclick = () => {
                editMessage(id, editInput.value);
            };

            // Set up delete button handler (with confirmation logic in modal)
            document.getElementById('modal-delete-btn').onclick = () => {
                // For simplicity, we directly delete here, but in a real app,
                // you would prompt a second confirmation step in the modal.
                if (window.confirm("Are you sure you want to delete this message?")) {
                    deleteMessage(id);
                }
            };
            
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            // Animate scale in
            document.getElementById('edit-modal').classList.remove('scale-95');
            document.getElementById('edit-modal').classList.add('scale-100');
        }

        function closeModal() {
            // Animate scale out
            document.getElementById('edit-modal').classList.remove('scale-100');
            document.getElementById('edit-modal').classList.add('scale-95');

            setTimeout(() => {
                modalContainer.classList.remove('flex');
                modalContainer.classList.add('hidden');
                document.getElementById('edit-modal').dataset.messageId = '';
            }, 300); // Wait for transition
        }
        
        // Allow clicking outside the modal to close it
        modalContainer.onclick = (e) => {
            if (e.target.id === 'modal-container') {
                closeModal();
            }
        };

        // --- Voice Message Recording (Optional Feature) ---

        async function startRecording() {
            if (!currentUserId) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    sendVoiceMessage(stream);
                };

                mediaRecorder.start();
                isRecording = true;
                recordStartBtn.classList.add('hidden');
                recordStopBtn.classList.remove('hidden');
            } catch (err) {
                console.error('Error starting recording:', err);
                // Optionally show a user-friendly error message
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecording = false;
                recordStartBtn.classList.remove('hidden');
                recordStopBtn.classList.add('hidden');
            }
        }

        async function sendVoiceMessage(stream) {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            
            // Close the stream tracks
            stream.getTracks().forEach(track => track.stop());

            // 1. Upload the audio file to Supabase Storage
            const filePath = `${currentUserId}/${Date.now()}.wav`;
            
            const { data: uploadData, error: uploadError } = await withExponentialBackoff(() => 
                supabaseClient.storage
                    .from('voice-messages') // You need to create this bucket in Supabase Storage
                    .upload(filePath, audioBlob, {
                        cacheControl: '3600',
                        upsert: false
                    })
            );

            if (uploadError) {
                console.error('Error uploading voice file:', uploadError);
                return;
            }

            // 2. Get the public URL for the file
            const { data: publicUrlData } = supabaseClient.storage
                .from('voice-messages')
                .getPublicUrl(filePath);

            const audioUrl = publicUrlData.publicUrl;

            // 3. Insert the message record into the 'messages' table
            const message = {
                sender_id: currentUserId,
                content: `(Voice Message)`, // Text content is just a placeholder
                audio_url: audioUrl,
                receiver_id: currentPartnerId
            };
            
            const { error: insertError } = await withExponentialBackoff(() => 
                supabaseClient
                    .from('messages')
                    .insert([message])
            );

            if (insertError) {
                console.error("Error inserting voice message record:", insertError);
                // In a real app, you'd also want to delete the uploaded file if the insert fails.
            }
        }

        // --- Event Listeners and Initializers ---

        // Send message on Enter key press
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            // Auto-resize textarea
            setTimeout(() => {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            }, 0);
        });
        
        // Expose functions globally for HTML event handlers
        window.sendMessage = sendMessage;
        window.editMessage = editMessage;
        window.deleteMessage = deleteMessage;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.setChatMode = setChatMode;


        // Workaround for window.confirm() issue in the sandbox
        window.deleteMessage = function (id) {
            const messageElement = document.getElementById('edit-modal');
            
            // Set up a temporary confirmation and deletion in the modal
            openModal(id, 'Are you sure you want to delete this message?');
            
            editInput.classList.add('hidden');
            document.getElementById('modal-save-btn').classList.add('hidden');
            document.getElementById('modal-delete-btn').textContent = 'Confirm Delete';
            
            document.getElementById('modal-delete-btn').onclick = async () => {
                const idToDelete = messageElement.dataset.messageId;
                
                const { error } = await withExponentialBackoff(() => 
                    supabaseClient
                        .from('messages')
                        .delete()
                        .eq('id', idToDelete)
                        .eq('sender_id', currentUserId) // Security check
                );

                if (error) {
                    console.error("Error deleting message:", error);
                }
                
                closeModal();
                // Since real-time listener might be slow, manually trigger a refresh
                // Requires a re-fetch to ensure the remaining list is correct
                fetchCurrentMessages().then(renderMessages);
                fetchActiveDMPartners(); // Update DM list on deletion
            };
        }

        function initializeSupabase() {
            if (SUPABASE_URL.includes('your-project-ref') || SUPABASE_ANON_KEY.includes('YOUR_ANON_PUBLIC_KEY')) {
                document.getElementById('auth-status').textContent = 'ERROR: Keys Missing';
                document.getElementById('auth-status').classList.replace('text-red-400', 'text-red-700');
                console.error("Supabase keys are missing. Please replace placeholders with actual project URL and Anon key.");
                return;
            }

            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            supabaseClient.auth.onAuthStateChange((event, session) => {
                updateAuthState(session);
            });
        }

        // Initialize button handlers for recording
        document.addEventListener('DOMContentLoaded', () => {
            // Voice recording handlers (already present)
            recordStartBtn.onclick = startRecording;
            recordStopBtn.onclick = stopRecording;
            updateHeader(); // Set initial public chat title
        });


        // Start the application setup
        window.onload = initializeSupabase;

    </script>
</body>
</html>
